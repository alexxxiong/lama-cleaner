# 需求文档

## 介绍

将 Lama Cleaner 的后端架构从同步处理模式改造为分布式的生产者-消费者模式。新架构将使用 ZeroMQ 作为轻量级消息队列组件，支持多个处理节点并行处理图像修复任务，每个节点可以根据自身的硬件能力订阅不同类型的任务队列。系统需要支持动态扩缩容、任务取消、以及与云服务商 serverless 服务的集成。选择 ZeroMQ 的原因是其轻量级、高性能、无需独立代理服务器的特点，非常适合中小规模的分布式处理场景。

## 需求

### 需求 1：队列管理系统

**用户故事：** 作为系统管理员，我希望有一个可靠的队列管理系统，以便能够将前端请求转换为异步任务并分发给合适的处理节点。

#### 验收标准

1. 当前端发送图像处理请求时，系统应该将请求转换为任务并通过 ZeroMQ 发送到相应的队列中
2. 当任务被创建时，系统应该根据任务类型（GPU密集型、CPU密集型等）将其路由到不同的 ZeroMQ socket 端点
3. 当队列中有任务时，系统应该能够将任务数据持久化到本地存储以防止丢失
4. 当系统重启时，未完成的任务应该能够从持久化存储中恢复并重新发送到队列
5. 如果内存中的任务队列达到最大容量，系统应该拒绝新任务并返回适当的错误信息

### 需求 2：处理节点管理

**用户故事：** 作为处理节点，我希望能够根据自身的硬件能力选择性地订阅和处理任务，以便最大化处理效率。

#### 验收标准

1. 当处理节点启动时，节点应该能够通过 ZeroMQ 向调度器注册自己的能力配置（GPU类型、内存大小、支持的模型等）
2. 当节点注册后，系统应该允许节点连接到匹配其能力的 ZeroMQ socket 端点（如 gpu-queue、cpu-queue 等）
3. 当节点空闲时，应该通过 ZeroMQ 的 PULL socket 从相应队列中拉取任务
4. 当节点处理任务时，应该通过 ZeroMQ 定期向调度器发送状态更新和进度信息
5. 如果节点长时间无响应，调度器应该检测到心跳超时并将其标记为离线，重新分配其任务

### 需求 3：任务生命周期管理

**用户故事：** 作为用户，我希望能够查看任务状态、取消正在处理的任务，以便更好地控制我的请求。

#### 验收标准

1. 当任务被创建时，系统应该返回唯一的任务ID给前端
2. 当用户查询任务状态时，系统应该返回当前状态（排队中、处理中、已完成、已失败、已取消）
3. 当用户请求取消任务时，如果任务还在队列中，系统应该立即移除任务
4. 当用户请求取消正在处理的任务时，系统应该通知处理节点停止处理
5. 当任务完成或失败时，系统应该通过WebSocket实时通知前端

### 需求 4：动态扩缩容支持

**用户故事：** 作为系统管理员，我希望系统能够根据负载情况自动或手动调整处理节点数量，以便优化资源使用和处理速度。

#### 验收标准

1. 当队列积压超过阈值时，系统应该能够触发扩容信号
2. 当系统负载较低时，系统应该能够安全地缩减处理节点
3. 当新节点加入时，系统应该自动发现并将其纳入调度
4. 当节点需要下线时，系统应该等待其完成当前任务后再移除
5. 如果节点强制下线，系统应该将其未完成的任务重新放入队列

### 需求 5：Serverless 集成支持

**用户故事：** 作为开发者，我希望能够将处理节点部署到云服务商的 serverless 平台，以便实现按需付费和快速扩缩容。

#### 验收标准

1. 当系统需要新的处理能力时，应该能够调用云服务商API创建 serverless 函数实例
2. 当 serverless 函数启动时，应该能够自动连接到队列系统并开始处理任务
3. 当任务处理完成且无新任务时，serverless 函数应该能够自动销毁以节省成本
4. 当 serverless 函数异常终止时，系统应该能够检测到并重新分配任务
5. 如果 serverless 平台返回错误，系统应该有降级策略使用本地处理节点

### 需求 6：监控和日志系统

**用户故事：** 作为系统管理员，我希望有完整的监控和日志系统，以便跟踪系统性能和排查问题。

#### 验收标准

1. 当任务在系统中流转时，系统应该记录详细的日志信息
2. 当系统运行时，应该收集关键指标（队列长度、处理时间、节点状态等）
3. 当出现异常时，系统应该记录错误详情和堆栈信息
4. 当管理员查询时，系统应该提供实时的监控面板
5. 如果系统指标超过预设阈值，应该发送告警通知

### 需求 7：容错和恢复机制

**用户故事：** 作为用户，我希望即使在系统部分组件故障的情况下，我的任务仍能得到处理，以便保证服务的可靠性。

#### 验收标准

1. 当处理节点崩溃时，系统应该检测到故障并将未完成任务重新分配
2. 当队列服务重启时，系统应该能够恢复所有未完成的任务
3. 当网络连接中断时，处理节点应该能够重新连接并继续工作
4. 当任务处理失败时，系统应该根据配置进行重试
5. 如果任务多次失败，系统应该将其标记为永久失败并通知用户

### 需求 8：API 兼容性

**用户故事：** 作为前端开发者，我希望新的分布式架构能够保持与现有API的兼容性，以便最小化前端代码的修改。

#### 验收标准

1. 当前端发送现有的 `/inpaint` 请求时，系统应该能够正常处理并返回兼容的响应
2. 当前端使用 WebSocket 连接时，系统应该保持现有的消息格式
3. 当前端查询处理进度时，系统应该返回与现有格式兼容的状态信息
4. 当系统升级时，应该提供平滑的迁移路径
5. 如果需要新的API端点，应该保持RESTful设计风格并提供清晰的文档